<%= stylesheet_link_tag "http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" %>

<div class="container well signin-form">
	<span class="pull-right">
		<%= link_to 'Visit Status Page', statuses_path  ,class: "text-danger"%>
	</span>
	<h3>	Sign In</h3>
	<br>
	<%= form_for Patient.new ,:html => { :class => 'form-inline signin' } do |f| %>
	  <div class="form-group">
	  		<%= label_tag :username, 'Username', :class => 'control-label' %>
			<%= f.text_field :username, :class =>'form-control', :placeholder => 'Credentials not saved' %>
	  </div>
	  <div class="form-group">
			<%= label_tag :password, 'Password', :class => 'control-label' %>
			<%= f.password_field :password, :class =>'form-control', :placeholder => 'Credentials not saved' %>
	  </div>

	  <div class="form-group">
			<%= label_tag "Website to Scrap data", "Website to Scrap data", :class=> 'control-label' %>
			<%= f.select :site_to_scrap, options_for_site,{} , {:class=> 'form-control'} %>
	  </div>
	  
		<%= submit_tag "", :value => "â–º check & save credentials", :class => "btn btn-sm btn-primary", id: 'submit-button' %>
		<div class="form-group">
			<%= label_tag "Service type", "Service type", :class=> 'control-label' %>
			<%= text_field_tag :serv_type, nil , {:class=> 'form-control'} %>
	  </div>
  <br>
	<% end %>
	</div>
	<div class="row">
		<div class="col-md-1">

		</div>
		<div class="well col-md-4 signup-form">
			<h4>Import Patients</h4>
			<br>
			<%= form_tag import_patients_path, multipart: true do %>
					<%= file_field_tag :file %><br />
					<%= submit_tag "Import Patients" ,:class => "btn btn-danger"%>
			<% end %>
		</div>

		<div class="col-md-1">

		</div>

		<div class="well col-md-4 signup-form">

			 <% id = Status.where(site_url: 'all').first.id %>

			<span class="pull-right">
			<%= link_to 'Download CSV', service_type_path(id)+".csv" ,class: "text-danger"%>
			</span>

			<h4>Import Service type mapping</h4>
			<br>
			<%=   form_tag import_mapping_patients_path(id), multipart: true do %>
					<%= file_field_tag :file %><br />
					<%= submit_tag "Import Service Type Mapping" ,:class => "btn btn-danger"%>
			<% end %>
	  </div>

	</div>
<%if !@patients.first.nil? %>
<div class="container well">

			<h4>Patients Detail</h4>
		<div class="table-responsive">
			<table class="table table-striped">
			  <thead>
			    <tr>
			      <th>First name</th>
			      <th>Last name</th>
			      <th>Patient</th>
			      <th>Date of birth</th>
			      <th colspan="3">    <%= link_to 'Delete All', delete_all_patients_path, data: { confirm: 'Are you sure?' }  ,class: "btn btn-xs btn-danger"%></th>
			    </tr>
			  </thead>

			  <tbody>

			    <% @patients.each do |patient,index| %>
			      <tr>

			        <!-- <td><%= index %></td> -->
			        <td><%= patient.first_name %></td>
			        <td><%= patient.last_name %></td>
			        <td><%= patient.patient_id %></td>
			        <td><%= patient.dob %></td>

			          <% if patient.record_available=='complete'%>
			           <td>
			            <%= form_for(patient) do %>
			          					<%= submit_tag "View", class: "btn btn-block btn-small btn-success" %>
			         				 <% end %>
			             <%elsif patient.record_available=='pending'%>
			             <td>
			          					<%= button_tag "Pending..", class: "btn btn-block btn-small btn-info" %>

			             <%elsif patient.record_available=='failed' %>
			             <td>
			             		 <%= form_for patient, :html => { :class => 'patient_form' } do |f| %>
			          					<%= f.hidden_field :username, value: "asd" %>
			             		 		<%= f.hidden_field :password, value: "asd" %>
			             		 		<%= f.hidden_field :serv_type, value: "asd" %>
			             		 		
			             		 		<%= f.hidden_field :site_to_scrap, value: "asd" %>
			          					<%= submit_tag "Re-Check", class: "btn btn-block btn-small btn-danger" %>
			         				 <% end %>

			             <%else%>
			             <td>
			             		 <%= form_for patient, :html => { :class => 'patient_form' } do |f| %>
			             		 		<%= f.hidden_field :username, value: "asd" %>
			             		 		<%= f.hidden_field :password, value: "asd" %>
			             		 		<%= f.hidden_field :serv_type, value: "asd" %>
			             		 		<%= f.hidden_field :site_to_scrap, value: "asd" %>
			          					<%= submit_tag "Check", class: "btn btn-block btn-small btn-warning" %>
			         				 <% end %>
 			           <%end %>
			      </tr>
			    <% end %>
			  </tbody>
			</table>
			</div>
			<br>
			<br><br>
</div>
<%end%>
<script type="text/javascript">


	function fillup_signin_fields(){
		selected_val = $('#patient_site_to_scrap option:selected').val()

		if(session_arr[selected_val]) {
			$('#patient_username').val(session_arr[selected_val]['username'])
			$('#patient_password').val(session_arr[selected_val]['password'])
		}
		else {
			$('#patient_username').val("")
			$('#patient_password').val("")
		}
	}


	$(document).ready(function(){
		session_arr = <%= raw(session.to_json) %>

		setTimeout(function() { fillup_signin_fields(); }, 300);

		$('#patient_site_to_scrap').on('change', function(){
			fillup_signin_fields()
		})

		$( ".patient_form" ).submit(function( event ) {
  		event.preventDefault();
  		$(this).children('#patient_username').val($('#patient_username').val().trim())
  		$(this).children('#patient_password').val($('#patient_password').val().trim())
  		$(this).children('#patient_serv_type').val($('#serv_type').val().trim())
  		$(this).children('#patient_site_to_scrap').val($('#patient_site_to_scrap option:selected').val().trim())
			this.submit()
		});
	})
</script>
